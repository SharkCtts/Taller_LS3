<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Gráficas de Stock</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        button {
            margin: 10px;
            padding: 10px 20px;
            font-size: 16px;
        }
        .chart-container {
            width: 80%;
            margin: auto;
        }
    </style>
</head>
<body>
    <h1 style="text-align:center;">Visualización de Gráficas</h1>

    <div style="text-align:center;">
        <button onclick="mostrarGrafica('categoria')">Stock por Categoría</button>
        <button onclick="mostrarGrafica('ventas')">Ventas por Artículo</button>
        <button onclick="mostrarGrafica('ingresos')">Ingresos por Artículo</button>
        <a href="{{ url_for('menu') }}"><button>Volver al Menú</button></a>
    </div>

    <!-- Botones -->

    <div id="mesSelector" style="text-align:center; margin-top: 10px; display: none;">
        <label for="mes">Selecciona un mes:</label>
        <select id="mes" onchange="filtrarPorMes()">
            <option value="">Todos</option>
            <option value="1">Enero</option>
            <option value="2">Febrero</option>
            <option value="3">Marzo</option>
            <option value="4">Abril</option>
            <option value="5">Mayo</option>
            <option value="6">Junio</option>
            <option value="7">Julio</option>
            <option value="8">Agosto</option>
            <option value="9">Septiembre</option>
            <option value="10">Octubre</option>
            <option value="11">Noviembre</option>
            <option value="12">Diciembre</option>
        </select>
    </div>

    <!-- La lista para seleccionar mese xd -->

    <div class="chart-container">
        <canvas id="grafico"></canvas>
    </div>

    <script>
        const categoriaData = {
            labels: {{ categorias.keys()|list|tojson }},
            datasets: [{
                label: 'Stock por Categoría',
                data: {{ categorias.values()|list|tojson }},
                backgroundColor: 'rgba(54, 162, 235, 0.6)'
            }]
        };

        const ventasData = {
            labels: {{ ventas.keys()|list|tojson }},
            datasets: [{
                label: 'Ventas por Artículo',
                data: {{ ventas.values()|list|tojson }},
                backgroundColor: 'rgba(248, 113, 113, 0.6)'
            }]
        };

        const ingresosData = {
            labels: {{ ingresos.keys()|list|tojson }},
            datasets: [{
                label: 'Ingresos por Artículo',
                data: {{ ingresos.values()|list|tojson }},
                backgroundColor: 'rgba(52, 211, 153, 0.6)'
            }]
        };

        const ctx = document.getElementById('grafico').getContext('2d');
        let chart = new Chart(ctx, {
            type: 'bar',
            data: categoriaData,
            options: { responsive: true, scales: { y: { beginAtZero: true } } }
        });
        
        let tipoActual = 'categoria';

        function mostrarGrafica(tipo) {
            tipoActual = tipo;
            document.getElementById('mesSelector').style.display = (tipo === 'ventas' || tipo === 'ingresos') ? 'block' : 'none';

            if (tipo === 'categoria') {
                actualizarGrafico(categoriaData);
            } else {
                // Llama a la API para obtener los datos filtrados
                cargarGrafico(tipo, '');
            }
        }


        function filtrarPorMes() {
            const mes = document.getElementById('mes').value;
            cargarGrafico(tipoActual, mes);
        } 

        function cargarGrafico(tipo, mes) {
            fetch(`/api/grafica?tipo=${tipo === 'ventas' ? 'venta' : 'ingreso'}&mes=${mes}`)
                .then(res => res.json())
                .then(data => {
                    const dataGrafica = {
                        labels: data.labels,
                        datasets: [{
                            label: `${tipo === 'ventas' ? 'Ventas' : 'Ingresos'} por Artículo`,
                            data: data.values,
                            backgroundColor: tipo === 'ventas'
                                ? 'rgba(248, 113, 113, 0.6)'
                                : 'rgba(52, 211, 153, 0.6)'
                        }]
                    };
                    actualizarGrafico(dataGrafica);
                });
        }


        function actualizarGrafico(data) {
            chart.destroy();
            chart = new Chart(ctx, {
                type: 'bar',
                data: data,
                options: { responsive: true, scales: { y: { beginAtZero: true } } }
            });
        }

    </script>
</body>
</html>
