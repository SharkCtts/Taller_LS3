<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>GrÃ¡ficas de Stock</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/graficas.css') }}">
</head>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    
    <div class="top-bar">
        
        <div class="space-x-2">
            
            <button onclick="location.href='{{ url_for('visualizar') }}'" class="menu-button">ðŸ“¦ Visualizar Stock</button>
            <button onclick="location.href='{{ url_for('graficas') }}'" class="menu-button">ðŸ“Š Ver GrÃ¡ficas</button>
            <button onclick="alert('Redirige a historial cuando estÃ© listo');" class="menu-button">ðŸ•“ Visualizar Historial</button>
        </div>
    
        <a href="{{ url_for('menu') }}">
            <button>Volver al MenÃº Principal</button>
        </a>

        <div class="user-button" onclick="toggleDropdown()">
            {{ username }}
            <img src="{{ url_for('static', filename='user_icon.png') }}" alt="User" width="30">
            <div class="dropdown" id="userDropdown">
                <a href="{{ url_for('logout') }}">Deslogearse</a>
            </div>
        </div>
    </div>
    
    <div style= "text-align: center; padding-top: 30px; padding: 20px 10px;">
        <button onclick="mostrarGrafica('categoria')">Stock por CategorÃ­a</button>
        <button onclick="mostrarGrafica('ventas')">Ventas por ArtÃ­culo</button>
        <button onclick="mostrarGrafica('ingresos')">Entradas por ArtÃ­culo</button>
        <a href="{{ url_for('menu') }}"><button>Volver al MenÃº</button></a>
    </div>

    <!-- Botones -->

    <div id="ganancia" style="text-align:center; font-size: 18px; font-weight: bold;"></div>

    <div id="mesSelector" style="text-align:center; margin-top: 10px; display: none;">
        <label for="mes">Selecciona un mes:</label>
        <select id="mes" onchange="filtrarPorMes()">

            <option value="">Todos</option>
            <option value="1">Enero</option>
            <option value="2">Febrero</option>
            <option value="3">Marzo</option>
            <option value="4">Abril</option>
            <option value="5">Mayo</option>
            <option value="6">Junio</option>
            <option value="7">Julio</option>
            <option value="8">Agosto</option>
            <option value="9">Septiembre</option>
            <option value="10">Octubre</option>
            <option value="11">Noviembre</option>
            <option value="12">Diciembre</option>
        </select>
    </div>

    <!-- La lista para seleccionar mese xd -->

    <div class="chart-container">
        <canvas id="grafico"></canvas>
    </div>

    <script>
    const ctx = document.getElementById('grafico').getContext('2d');
    let chart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: [],
            datasets: [{
                label: '',
                data: [],
                backgroundColor: ''
            }]
        },
        options: { responsive: true, scales: { y: { beginAtZero: true } } }
    });

    let tipoActual = 'categoria';

    function mostrarGrafica(tipo) {
        tipoActual = tipo;
        const selector = document.getElementById('mesSelector');
        const gananciaDiv = document.getElementById('ganancia');
        selector.style.display = tipo === 'ventas' ? 'block' : 'none';
        gananciaDiv.innerText = '';  // limpia ganancia al cambiar tipo

        if (tipo === 'categoria') {
            actualizarGrafico({
                labels: {{ categorias.keys()|list|tojson }},
                datasets: [{
                    label: 'Stock por CategorÃ­a',
                    data: {{ categorias.values()|list|tojson }},
                    backgroundColor: 'rgba(54, 162, 235, 0.6)'
                }]
            });
        } else {
            cargarGrafico(tipo, document.getElementById('mes').value);
        }
    }

    function filtrarPorMes() {
        const mes = document.getElementById('mes').value;
        cargarGrafico(tipoActual, mes);
    }

    function cargarGrafico(tipo, mes) {
        fetch(`/api/grafica?tipo=${tipo === 'ventas' ? 'venta' : 'ingreso'}&mes=${mes}`)
            .then(res => res.json())
            .then(data => {
                const color = tipo === 'ventas'
                    ? 'rgba(248, 113, 113, 0.6)'
                    : 'rgba(52, 211, 153, 0.6)';

                actualizarGrafico({
                    labels: data.labels,
                    datasets: [{
                        label: `${tipo === 'ventas' ? 'Ventas' : 'Ingresos'} por ArtÃ­culo`,
                        data: data.values,
                        backgroundColor: color
                    }]
                });

                // Mostrar ganancia si corresponde
                const div = document.getElementById('ganancia');
                if (tipo === 'ventas' && data.ganancia !== null) {
                    div.innerText = `Ganancia en el mes: $${data.ganancia.toFixed(2)}`;
                }
            });
    }

    function actualizarGrafico(data) {
        chart.destroy();
        chart = new Chart(ctx, {
            type: 'bar',
            data: data,
            options: { responsive: true, scales: { y: { beginAtZero: true } } }
        });
    }

    // Mostrar la grÃ¡fica por defecto al cargar
    window.onload = () => {
        mostrarGrafica('categoria');
    };
</script>

</body>
</html>
